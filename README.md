# ğŸ¥ PancakeSwap BNB/USD é æ¸¬éŠæˆ²æ­·å²æ•¸æ“šæŠ“å–ç³»çµ±è¨­è¨ˆæ–‡ä»¶ (æœ€çµ‚ç‰ˆ)

> **ç‰ˆæœ¬**ï¼šv2.2 (å«éŒ¯èª¤æ—¥èªŒ)
> **æ ¸å¿ƒæŠ€è¡“**ï¼šNode.js + ethers.js + Redis
> **ç›®æ¨™**ï¼šé›™è»Œæ•¸æ“šæŠ“å–ã€ä½µç™¼æ§åˆ¶ã€äº‹å‹™æ€§å¯«å…¥ã€æ•¸æ“šå®Œæ•´æ€§é©—è­‰
> **è¦ç¯„**ï¼šæ‰€æœ‰å‘½åå¼·åˆ¶é§å³°å¼ (camelCase)

---

## 1. ğŸ”— åŸºç¤è³‡è¨Š

| é …ç›® | å€¼ |
| :--- | :--- |
| **åˆç´„åœ°å€** | `0x18B2A687610328590Bc8F2e5fEdDe3b582A49cdA` |
| **ABI è·¯å¾‘** | `./abi.json` |
| **BSC RPC Endpoint** | `https://lb.drpc.live/bsc/Ahc3I-33qkfGuwXSahR3XfMHZiZ_sBMR8Lq_QrxF2MGT` |
| **RPC æ”¯æ´** | å–®æ¬¡è«‹æ±‚æœ€å¤š 100,000 å€‹å€å¡Š |
| **çµ±ä¸€æ™‚å€** | å°åŒ—æ™‚é–“ (UTC+8) |
| **æ™‚é–“æ ¼å¼** | `YYYY-MM-DD HH:mm:ss` (ç„¡æ¯«ç§’ã€ç„¡æ™‚å€æ¨™ç¤º) |

---

## 2. ğŸ§© ç³»çµ±æ¶æ§‹ï¼šä¸»ç·šã€æ”¯ç·šèˆ‡ä½µç™¼æ§åˆ¶

### âœ… 2.1 ä¸»ç·š (Main Thread)
* **è§¸ç™¼**ï¼šç¨‹å¼å•Ÿå‹•æ™‚ç«‹å³åŸ·è¡Œã€‚
* **ä»»å‹™**ï¼šå–å¾—ç•¶å‰æœ€æ–°å±€æ¬¡ `currentEpoch`ã€‚å¾ `currentEpoch - 2` é–‹å§‹**æŒçºŒå‘æ­·å²å›æº¯** (`n-2`, `n-3`, `n-4`, ...)ã€‚
* **åŸ·è¡Œé‚è¼¯**ï¼šå°æ–¼**æ¯ä¸€å±€** (`n-2`, `n-3`...)ï¼Œå‡åŸ·è¡Œä»¥ä¸‹æª¢æŸ¥ï¼š
    1.  **æª¢æŸ¥ `finEpoch` è¡¨**ï¼šè‹¥è©²å±€ `epoch` å·²å­˜åœ¨ï¼Œå‰‡**è·³éæ­¤å±€ï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€å±€** (`epoch - 1`)ã€‚
    2.  **æª¢æŸ¥ `Redis` é–**ï¼šè‹¥è©²å±€ `epoch` å·²è¢«é–å®šï¼ˆè©³è¦‹ 2.5 ç¯€ï¼‰ï¼Œå‰‡**è·³éæ­¤å±€ï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€å±€** (`epoch - 1`)ã€‚
    3.  **åŸ·è¡ŒæŠ“å–**ï¼šè‹¥ 1 å’Œ 2 å‡é€šéï¼Œå‰‡é–‹å§‹åŸ·è¡ŒæŠ“å–ã€é©—è­‰èˆ‡å¯«å…¥æµç¨‹ã€‚
* **é‡å•Ÿ**ï¼šæ¯ **30 åˆ†é˜é€²è¡Œä¸€æ¬¡å„ªé›…é‡å•Ÿ**ã€‚

### âœ… 2.2 æ”¯ç·š (Secondary Thread)
* **è§¸ç™¼**ï¼šç¨‹å¼å•Ÿå‹•å¾Œ **5 åˆ†é˜é¦–æ¬¡è§¸ç™¼**ï¼Œä¹‹å¾Œ**æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡**ã€‚
* **ä»»å‹™**ï¼šåƒ…è² è²¬ `currentEpoch - 2`, `currentEpoch - 3`, `currentEpoch - 4` é€™ä¸‰å±€ã€‚
* **åŸ·è¡Œé‚è¼¯**ï¼šå°æ–¼é€™ä¸‰å±€ä¸­çš„**æ¯ä¸€å±€**ï¼Œå‡åŸ·è¡Œä»¥ä¸‹æª¢æŸ¥ï¼š
    1.  **æª¢æŸ¥ `finEpoch` è¡¨**ï¼šè‹¥è©²å±€ `epoch` å·²å­˜åœ¨ï¼Œå‰‡**è·³éæ­¤å±€**ã€‚
    2.  **æª¢æŸ¥ `Redis` é–**ï¼šè‹¥è©²å±€ `epoch` å·²è¢«é–å®šï¼Œå‰‡**è·³éæ­¤å±€**ã€‚
    3.  **åŸ·è¡ŒæŠ“å–**ï¼šè‹¥ 1 å’Œ 2 å‡é€šéï¼Œå‰‡åŸ·è¡ŒæŠ“å–ã€é©—è­‰èˆ‡å¯«å…¥æµç¨‹ã€‚

### âœ… 2.5 âš¡ ä½µç™¼æ§åˆ¶ (Redis é–)

ç‚ºé˜²æ­¢ä¸»ç·šèˆ‡æ”¯ç·šåœ¨åŒä¸€æ™‚åˆ»æŠ“å–åŒä¸€å±€ `epoch`ï¼ˆRace Conditionï¼‰ï¼Œå¼•å…¥ Redis é–æ©Ÿåˆ¶ã€‚

* **é– Key æ ¼å¼**ï¼š`lock:pancake:epoch:{epoch}` (ä¾‹å¦‚: `lock:pancake:epoch:483750`)
* **é– TTL (éæœŸæ™‚é–“)**ï¼š`120` ç§’ (2 åˆ†é˜)ã€‚
    * *ï¼ˆå‚™è¨»ï¼šæ­¤ TTL æ‡‰ç•¥å¤§æ–¼æŠ“å–+é©—è­‰+å¯«å…¥å–®å±€æ‰€éœ€çš„å¹³å‡æ™‚é–“ï¼Œä»¥é˜²è…³æœ¬æ„å¤–å´©æ½°å°è‡´æ­»é–ï¼‰*

#### åŸ·è¡Œæµç¨‹ï¼š
1.  **æª¢æŸ¥ `finEpoch`**ï¼š(å¦‚ 2.1 / 2.2 æ‰€è¿°)ã€‚è‹¥å­˜åœ¨ï¼Œè·³éã€‚
2.  **å˜—è©¦ç²å–é–**ï¼š(è‹¥ `finEpoch` ä¸å­˜åœ¨)
    * åŸ·è¡Œ Redis `SET` å‘½ä»¤ä¸¦å¸¶ä¸Š `NX` (Not Exists) å’Œ `EX` (Expire) åƒæ•¸ã€‚
    * ä¾‹å¦‚ï¼š`SET lock:pancake:epoch:483750 processing NX EX 120`
3.  **åˆ¤æ–·é–ç‹€æ…‹**ï¼š
    * **ç²å–æˆåŠŸ** (`SET` è¿”å› `OK` æˆ– `1`)ï¼šè¡¨ç¤ºæ­¤ç·šç¨‹å·²å–å¾—è™•ç†æ¬Šã€‚ç«‹å³é–‹å§‹åŸ·è¡Œ[æ•¸æ“šæŠ“å–](#3-æ•¸æ“šæŠ“å–ç­–ç•¥äºŒåˆ†æœå°‹--å€å¡Šç¯„åœå®šä½)ã€‚
    * **ç²å–å¤±æ•—** (`SET` è¿”å› `nil` æˆ– `0`)ï¼šè¡¨ç¤ºè©² `epoch` å·²è¢«å¦ä¸€ç·šç¨‹é–å®šä¸¦æ­£åœ¨è™•ç†ä¸­ã€‚**ç«‹å³è·³éæ­¤å±€**ã€‚
4.  **é‡‹æ”¾é–**ï¼š
    * åœ¨äº‹å‹™**æˆåŠŸæäº¤**å¾Œï¼Œ**æˆ–**åœ¨æµç¨‹ä¸­**ç™¼ç”Ÿä»»ä½•éŒ¯èª¤**å°è‡´ä¸­æ–·æ™‚ï¼Œ**éƒ½å¿…é ˆ**åœ¨ `finally` å€å¡Šä¸­åŸ·è¡Œ `DEL` ä¾†é‡‹æ”¾é–ã€‚

---

## 3. ğŸ” æ•¸æ“šæŠ“å–ç­–ç•¥ï¼šäºŒåˆ†æœå°‹ + å€å¡Šç¯„åœå®šä½

å°æ¯ä¸€ç›®æ¨™å±€æ¬¡ `epoch`ï¼š

1.  å–å¾—è©²å±€çš„ `startTime` èˆ‡ä¸‹ä¸€å±€çš„ `startTime`ï¼Œä½œç‚ºæ™‚é–“æŸ¥è©¢å€é–“ `[start, nextStart)`ã€‚
2.  ä½¿ç”¨ **äºŒåˆ†æœå°‹æ³•** æ‰¾å‡ºå°æ‡‰çš„èµ·å§‹èˆ‡çµæŸå€å¡Šè™Ÿã€‚
3.  åˆ©ç”¨ RPC **å–®æ¬¡æœ€å¤§ 10 è¬å€å¡Šæ‰¹é‡æŸ¥è©¢èƒ½åŠ›**ï¼Œä¸€æ¬¡æ€§ç²å–æ­¤å€é–“å…§æ‰€æœ‰ç›¸é—œäº‹ä»¶æ—¥èªŒï¼ˆ`LockEvent`, `CloseRoundEvent`, `BetEvent` (BetBull/BetBear), `ClaimEvent`ï¼‰ã€‚
4.  å› åªæŠ“ `currentEpoch - 2` ä»¥å¾Œçš„æ•¸æ“šï¼Œæ‰€æœ‰å›åˆå‡å·²çµç®—ï¼Œç„¡æœªå®Œæˆç‹€æ…‹é¢¨éšªã€‚

---

## 4. ğŸ—‚ï¸ è³‡æ–™çµæ§‹å®šç¾© (å¼·åˆ¶ camelCase)

> **è¦ç¯„**ï¼šæ‰€æœ‰è¡¨èˆ‡æ¬„ä½å‡ä½¿ç”¨ `camelCase`ã€‚ç¦æ­¢æ·»åŠ  `id`, `hash`, `createdAt`, `updatedAt` ç­‰ä»»ä½•æœªæåŠçš„æ¬„ä½ã€‚

### 4.1 `round` è¡¨
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
| :--- | :--- | :--- |
| epoch | `BIGINT` | å±€æ¬¡ç·¨è™Ÿ (Primary Key) |
| startTime | `DATETIME` | é–‹å§‹æ™‚é–“ (å°åŒ—æ™‚å€) |
| lockTime | `DATETIME` | é–å€‰æ™‚é–“ (å°åŒ—æ™‚å€) |
| closeTime | `DATETIME` | çµæŸæ™‚é–“ (å°åŒ—æ™‚å€) |
| lockPrice | `DECIMAL(18,8)` | é–å€‰åƒ¹æ ¼ (USD) |
| closePrice | `DECIMAL(18,8)` | æ”¶ç›¤åƒ¹æ ¼ (USD) |
| result | `ENUM('up','down')` | çµæœ |
| totalAmount | `DECIMAL(18,8)` | ç¸½ä¸‹æ³¨é‡‘é¡ (BNB) |
| upAmount | `DECIMAL(18,8)` | çœ‹æ¼²æ–¹ä¸‹æ³¨ç¸½é¡ |
| downAmount | `DECIMAL(18,8)` | çœ‹è·Œæ–¹ä¸‹æ³¨ç¸½é¡ |
| upOdds | `DECIMAL(18,4)` | çœ‹æ¼²è³ ç‡ |
| downOdds | `DECIMAL(18,4)` | çœ‹è·Œè³ ç‡ |

> **è³ ç‡è¨ˆç®—å…¬å¼**ï¼š
> ```
> poolAfterFee = totalAmount * 0.97
> upOdds = poolAfterFee / upAmount
> downOdds = poolAfterFee / downAmount
> ```

### 4.2 `hisBet` è¡¨
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
| :--- | :--- | :--- |
| epoch | `BIGINT` | å°æ‡‰å±€æ¬¡ |
| betTime | `DATETIME` | ä¸‹æ³¨æ™‚é–“ (å°åŒ—æ™‚å€) |
| walletAddress | `VARCHAR(42)` | éŒ¢åŒ…åœ°å€ (å…¨å°å¯«) |
| betDirection | `ENUM('up','down')` | ä¸‹æ³¨æ–¹å‘ |
| betAmount | `DECIMAL(18,8)` | ä¸‹æ³¨é‡‘é¡ (BNB) |
| result | `ENUM('win','loss')` | çµæœ |
| blockNumber | `BIGINT` | ç™¼ç”Ÿå€å¡Šè™Ÿ |

### 4.3 `claim` è¡¨
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
| :--- | :--- | :--- |
| epoch | `BIGINT` | è§¸ç™¼æé ˜å‹•ä½œçš„ç•¶å‰å±€æ¬¡ |
| walletAddress | `VARCHAR(42)` | æé ˜è€…çš„éŒ¢åŒ…åœ°å€ |
| betEpoch | `BIGINT` | å¯¦éš›è¦é ˜å–çé‡‘çš„æ­·å²å±€æ¬¡ |
| claimAmount | `DECIMAL(18,8)` | é ˜å–é‡‘é¡ (BNB) |
> **å”¯ä¸€ç´¢å¼•**ï¼š`UNIQUE(epoch, walletAddress, betEpoch)`

### 4.4 `multiClaim` è¡¨ (å·¨é¯¨è¡Œç‚ºåµæ¸¬)
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
| :--- | :--- | :--- |
| epoch | `BIGINT` | è§¸ç™¼æé ˜çš„å±€æ¬¡ |
| walletAddress | `VARCHAR(42)` | éŒ¢åŒ…åœ°å€ |
| claimCount | `INT` | æœ¬æ¬¡å…±é ˜å–å¤šå°‘å±€çš„çé‡‘ |
| totalAmount | `DECIMAL(18,8)` | ç¸½é ˜å–é‡‘é¡ (BNB) |

### 4.5 `realBet` è¡¨ (è‡¨æ™‚/å³æ™‚æ•¸æ“šè¡¨)
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
| :--- | :--- | :--- |
| epoch | `BIGINT` | å°æ‡‰å±€æ¬¡ |
| betTime | `DATETIME` | ä¸‹æ³¨æ™‚é–“ (å°åŒ—æ™‚å€) |
| walletAddress | `VARCHAR(42)` | éŒ¢åŒ…åœ°å€ (å…¨å°å¯«) |
| betDirection | `ENUM('up','down')` | ä¸‹æ³¨æ–¹å‘ |
| betAmount | `DECIMAL(18,8)` | ä¸‹æ³¨é‡‘é¡ (BNB) |
| blockNumber | `BIGINT` | ç™¼ç”Ÿå€å¡Šè™Ÿ |
> **ç”¨é€”**ï¼šç”±å…¶ä»–å³æ™‚ç³»çµ±å¯«å…¥ã€‚æœ¬æ­·å²æŠ“å–ç³»çµ±çš„è·è²¬æ˜¯åœ¨äº‹å‹™ä¸­**æ¸…é™¤**æ­¤è¡¨ä¸­å°æ‡‰ `epoch` çš„æ•¸æ“šã€‚

### 4.6 `finEpoch` è¡¨ (å®Œæˆæ¨™è¨˜)
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
| :--- | :--- | :--- |
| epoch | `BIGINT` | å·²å®Œæ•´é©—è­‰ä¸¦æˆåŠŸå¯«å…¥çš„å±€æ¬¡ (Primary Key) |
> **ç”¨é€”**ï¼šä¸»ç·šèˆ‡æ”¯ç·šå•Ÿå‹•æ™‚æŸ¥è©¢æ­¤è¡¨ï¼Œè·³éå·²å®Œæˆçš„å±€æ¬¡ã€‚

### 4.7 `errEpoch` è¡¨ (éŒ¯èª¤æ—¥èªŒè¡¨)
| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
| :--- | :--- | :--- |
| epoch | `BIGINT` | æŠ“å–å¤±æ•—çš„å±€æ¬¡ (Primary Key) |
| errorTime | `DATETIME` | éŒ¯èª¤ç™¼ç”Ÿæ™‚é–“ (å°åŒ—æ™‚å€) |
| errorMessage | `TEXT` | éŒ¯èª¤è¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šé©—è­‰å¤±æ•—ã€RPC éŒ¯èª¤ã€DB éŒ¯èª¤ï¼‰|
> **ç”¨é€”**ï¼šåœ¨ `catch` å€å¡Šä¸­æ•ç²åˆ°ä»»ä½•è™•ç†éŒ¯èª¤æ™‚ï¼Œå°‡è©² `epoch` åŠéŒ¯èª¤è¨Šæ¯å¯«å…¥æ­¤è¡¨ã€‚
> **æ³¨æ„**ï¼šå¯«å…¥æ­¤è¡¨æ‡‰**ç¨ç«‹æ–¼ä¸»äº‹å‹™**ï¼Œå³ä½¿ä¸»äº‹å‹™å›æ»¾ï¼ŒéŒ¯èª¤æ—¥èªŒä¹Ÿæ‡‰æˆåŠŸå¯«å…¥ã€‚

---

## 5. âœ… æ•¸æ“šå®Œæ•´æ€§é©—è­‰æµç¨‹ (äº‹å‹™å‰åŸ·è¡Œ)

åœ¨æº–å‚™å¯«å…¥è³‡æ–™åº«å‰ï¼Œå¿…é ˆå°è©² `epoch` çš„æ•¸æ“šå®Œæˆä»¥ä¸‹é©—è­‰ï¼š

1.  **`round` è¡¨å®Œæ•´æ€§**
    * æ‰€æœ‰æ¬„ä½éç©º (Not Null)ã€‚
    * `upAmount > 0` ä¸” `downAmount > 0`ã€‚
    * `Math.abs(totalAmount - (upAmount + downAmount)) <= 0.0001`ã€‚
    * è³ ç‡è¨ˆç®—æ­£ç¢ºã€‚

2.  **`hisBet` ç¸½é¡æ ¸å°**
    * è¨ˆç®—è©² `epoch` æ‰€æœ‰ `hisBet.betAmount` ç¸½å’Œã€‚
    * æ ¸å°æ˜¯å¦æ¥è¿‘ `round.totalAmount` (**èª¤å·® â‰¤ 0.001 BNB**)ã€‚

3.  **`claim` è¡¨å®Œæ•´æ€§é©—è­‰**
    * **é©—è­‰è¦å‰‡**ï¼šæ ¹æ“šæ¥­å‹™ç¢ºèªï¼Œæ¯ä¸€å±€å·²çµç®—çš„ `epoch` éƒ½**å¿…å®šæœ‰é ˜çè³‡æ–™**ã€‚
    * **éŒ¯èª¤è™•ç†**ï¼šå¿…é ˆé©—è­‰æŠ“å–åˆ°çš„ `claim` è³‡æ–™**ä¸å¾—ç‚ºç©º** (`claimData.length > 0`)ã€‚å¦‚æœç‚º 0 ç­†ï¼Œä»£è¡¨æŠ“å–é‚è¼¯æœ‰èª¤æˆ– RPC æ•¸æ“šä¸å…¨ï¼Œæ‡‰**ç«‹å³ä¸­æ–·**æ­¤å±€è™•ç†ã€è¨˜éŒ„åš´é‡éŒ¯èª¤ï¼Œä¸¦**é‡‹æ”¾ Redis é–**ï¼ˆä»¥ä¾¿é‡è©¦ï¼‰ã€‚

4.  **`multiClaim` è³‡æ–™ç”Ÿæˆ**
    * æ ¹æ“š `claim` è¡¨èšåˆæ¯ä½ç”¨æˆ¶åœ¨å–®ä¸€ `epoch` çš„æé ˜ç­†æ•¸èˆ‡ç¸½é¡ã€‚
    * **è§¸ç™¼æ¢ä»¶** (ä»»ä¸€æˆç«‹å³è¨˜éŒ„)ï¼š
        * åŒä¸€éŒ¢åŒ…åœ¨åŒä¸€ `epoch` æé ˜å±€æ•¸ `claimCount >= 5`
        * æˆ–ç¸½æé ˜é‡‘é¡ `totalAmount >= 1 BNB`

---

## 6. ğŸ›‘ äº‹å‹™å¯«å…¥èˆ‡è¦†è“‹æ©Ÿåˆ¶

æ•¸æ“šæŠ“å–èˆ‡é©—è­‰å®Œæˆå¾Œï¼ˆå‰ææ˜¯å·²é€šé `finEpoch` æª¢æŸ¥èˆ‡ `Redis` é–ï¼‰ï¼Œåš´æ ¼åŸ·è¡Œä»¥ä¸‹äº‹å‹™æ€§å¯«å…¥æµç¨‹ï¼š

1.  **æº–å‚™äº‹å‹™**ï¼šå•Ÿå‹•è³‡æ–™åº«äº‹å‹™ (Transaction)ã€‚
2.  **æ¸…ç†è‡¨æ™‚æ•¸æ“š (åƒ… realBet)**ï¼šåœ¨äº‹å‹™å…§ï¼Œ**é¦–å…ˆä¸”åƒ…åˆªé™¤ `realBet` è¡¨ä¸­**æ‰€æœ‰ `epoch` æ¬„ä½ç­‰æ–¼ç•¶å‰ç›®æ¨™å±€æ¬¡çš„è‡¨æ™‚æ•¸æ“šã€‚
3.  **æ‰¹é‡å¯«å…¥**ï¼šåœ¨äº‹å‹™å…§ï¼Œå°‡é©—è­‰é€šéçš„ `roundData`, `hisBetData`, `claimData`, `multiClaimData` (è‹¥æœ‰) æ‰¹é‡æ’å…¥å°æ‡‰è¡¨æ ¼ã€‚
    * *ï¼ˆè¨»ï¼šæ­¤è™•ä¾è³´ `finEpoch` æª¢æŸ¥ä¾†ä¿è­‰ `round` ç­‰è¡¨çš„ä¸»éµä¸é‡è¤‡ã€‚è‹¥å› æ„å¤–å°è‡´ä¸»éµè¡çªï¼Œäº‹å‹™å°‡è‡ªå‹•å¤±æ•—ä¸¦å›æ»¾ã€‚ï¼‰*
4.  **æ¨™è¨˜å®Œæˆ (åƒ… finEpoch)**ï¼šåœ¨äº‹å‹™å…§ï¼Œ**åƒ…å°‡**è©² `epoch` å¯«å…¥ `finEpoch` è¡¨ï¼Œæ¨™è¨˜æœ¬æ­·å²æŠ“å–ç³»çµ±å·²å®Œæˆæ­¤å±€ã€‚
5.  **æäº¤äº‹å‹™**ï¼šæäº¤ (Commit) äº‹å‹™ã€‚è‹¥ä¸­é€”ä»»ä¸€æ­¥é©Ÿå¤±æ•—ï¼ˆåŒ…æ‹¬ä¸»éµè¡çªï¼‰ï¼Œå‰‡**è‡ªå‹•å›æ»¾ (Rollback)**ï¼Œç¢ºä¿æ•¸æ“šä¸€è‡´æ€§ã€‚

---

## 7. ğŸ’» äº‹å‹™ç¨‹å¼ç¢¼ç¯„ä¾‹ (ç¤ºæ„)

```javascript
// (å‡è¨­å·²æˆåŠŸç²å– Redis é–)
try {
  // ... (åŸ·è¡Œ 3. æŠ“å– å’Œ 5. é©—è­‰) ...
  // (å‡è¨­ 5. é©—è­‰é€šé)

  // é©—è­‰é€šéï¼Œé–‹å§‹äº‹å‹™
  await db.transaction(async (trx) => {
    
    // 2. æ¸…ç†è‡¨æ™‚æ•¸æ“š (åƒ… realBet)
    await trx('realBet').where({ epoch }).del();

    // 3. æ‰¹é‡å¯«å…¥æ–°è³‡æ–™
    await trx.insert(roundData).into('round');
    await trx.insert(hisBetData).into('hisBet');
    await trx.insert(claimData).into('claim'); // å·²é€šéé©—è­‰ï¼Œä¸ç‚ºç©º
    
    if (multiClaimData.length > 0) {
      await trx.insert(multiClaimData).into('multiClaim');
    }

    // 4. æ¨™è¨˜å®Œæˆ (åƒ…å¯«å…¥ finEpoch)
    await trx.insert({ epoch }).into('finEpoch');
  });

} catch (error) {
  // è¨˜éŒ„éŒ¯èª¤ (ä¾‹å¦‚é©—è­‰å¤±æ•—ã€ä¸»éµè¡çªç­‰)
  console.error(`è™•ç† Epoch ${epoch} å¤±æ•—:`, error);
  
  // (æ–°å¢) å¯«å…¥éŒ¯èª¤æ—¥èªŒ
  try {
    await db('errEpoch').insert({
      epoch: epoch,
      errorTime: new Date(), // ç¢ºä¿è½‰æ›ç‚ºå°åŒ—æ™‚å€ YYYY-MM-DD HH:mm:ss
      errorMessage: error.message || error.toString()
    }).onConflict('epoch').merge(); // å¦‚æœå·²å­˜åœ¨å‰‡æ›´æ–°éŒ¯èª¤è¨Šæ¯
  } catch (logError) {
    console.error(`å¯«å…¥ errEpoch å¤±æ•—:`, logError);
  }
  
  // äº‹å‹™å·²è‡ªå‹•å›æ»¾ (ROLLBACK)

} finally {
  // é‡‹æ”¾é– (ç„¡è«–æˆåŠŸæˆ–å¤±æ•—)
  await redis.del(`lock:pancake:epoch:${epoch}`);
}