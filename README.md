# ğŸ¥ PancakeSwap BNB/USD é æ¸¬éŠæˆ²æ­·å²æ•¸æ“šæŠ“å–ç³»çµ±

> **ç‰ˆæœ¬**ï¼šv2.2 (å«éŒ¯èª¤æ—¥èªŒ)
> **æ ¸å¿ƒæŠ€è¡“**ï¼šNode.js + ethers.js + Redis + PostgreSQL
> **ç›®æ¨™**ï¼šé›™è»Œæ•¸æ“šæŠ“å–ã€ä½µç™¼æ§åˆ¶ã€äº‹å‹™æ€§å¯«å…¥ã€æ•¸æ“šå®Œæ•´æ€§é©—è­‰

## ğŸ“‹ é …ç›®æ¦‚è¿°

æœ¬ç³»çµ±å°ˆç‚º PancakeSwap BNB/USD é æ¸¬éŠæˆ²è¨­è¨ˆçš„æ­·å²æ•¸æ“šæŠ“å–èˆ‡è™•ç†ç³»çµ±ï¼Œèƒ½å¤ è‡ªå‹•å¾ BSC å€å¡ŠéˆæŠ“å–é æ¸¬éŠæˆ²çš„æ­·å²æ•¸æ“šï¼Œé€²è¡Œå®Œæ•´æ€§é©—è­‰ï¼Œä¸¦å­˜å„²åˆ°è³‡æ–™åº«ä¸­ã€‚

### âœ¨ æ ¸å¿ƒåŠŸèƒ½

- ğŸ”„ **é›™è»Œä½µç™¼æ§åˆ¶**ï¼šä¸»ç·šæŒçºŒæ­·å²å›æº¯ + æ”¯ç·šå®šæœŸæª¢æŸ¥æœ€æ–°å±€æ¬¡
- ğŸ”’ **åˆ†ä½ˆå¼é–æ©Ÿåˆ¶**ï¼šRedis é–é˜²æ­¢ race condition
- ğŸ“Š **æ™ºèƒ½æ•¸æ“šæŠ“å–**ï¼šäºŒåˆ†æœå°‹ + å€å¡Šç¯„åœå®šä½
- âœ… **æ•¸æ“šå®Œæ•´æ€§é©—è­‰**ï¼šå¤šå±¤é©—è­‰ç¢ºä¿æ•¸æ“šæº–ç¢ºæ€§
- ğŸ’¾ **äº‹å‹™æ€§å¯«å…¥**ï¼šç¢ºä¿è·¨è¡¨æ•¸æ“šä¸€è‡´æ€§
- ğŸ“ **å®Œæ•´æ—¥èªŒç³»çµ±**ï¼šæ”¯æ´æ–‡ä»¶è¼¸å‡ºå’Œå¤šç¨®æ—¥èªŒç´šåˆ¥
- âš¡ **æ€§èƒ½å„ªåŒ–**ï¼šæ‰¹é‡è™•ç†ã€åˆ†å€æŸ¥è©¢ã€å…§å­˜å„ªåŒ–

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»ç·šç¨‹        â”‚    â”‚   æ”¯ç·šç·šç¨‹      â”‚    â”‚   èª¿åº¦å™¨        â”‚
â”‚  (æ­·å²å›æº¯)     â”‚    â”‚  (æœ€æ–°æª¢æŸ¥)     â”‚    â”‚  (ä»»å‹™ç®¡ç†)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      HisBetScraper (ä¸»æ§åˆ¶å™¨)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EventScraper   â”‚  â”‚ DataValidator   â”‚  â”‚ TransactionMgr  â”‚
â”‚  (å€å¡Šéˆäº¤äº’)   â”‚  â”‚ (æ•¸æ“šé©—è­‰)     â”‚  â”‚ (äº‹å‹™ç®¡ç†)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BSC RPC        â”‚  â”‚ Database        â”‚  â”‚ Redis Lock      â”‚
â”‚  (å€å¡Šéˆæ•¸æ“š)   â”‚  â”‚ (PostgreSQL)    â”‚  â”‚ (åˆ†ä½ˆå¼é–)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒè¦æ±‚

- Node.js >= 16.0.0
- PostgreSQL 12+
- Redis 6+
- BSC ç¶²çµ¡è¨ªå•æ¬Šé™

### å®‰è£æ­¥é©Ÿ

1. **å…‹éš†é …ç›®**
```bash
git clone <repository-url>
cd hisbet-data-scraper
```

2. **å®‰è£ä¾è³´**
```bash
npm install
```

3. **é…ç½®ç’°å¢ƒè®Šé‡**
```bash
cp .env.example .env
# ç·¨è¼¯ .env æ–‡ä»¶ï¼Œå¡«å…¥æ­£ç¢ºçš„é…ç½®ä¿¡æ¯
```

4. **å‰µå»ºæ•¸æ“šåº«çµæ§‹**
```bash
npm run create-schema
```

5. **æ¸¬è©¦é€£æ¥**
```bash
npm test
```

6. **å•Ÿå‹•ç³»çµ±**
```bash
npm start
# æˆ–è€…é–‹ç™¼æ¨¡å¼
npm run dev
```

## âš™ï¸ é…ç½®èªªæ˜

### ç’°å¢ƒè®Šé‡ (.env)

```bash
# BSC å€å¡Šéˆ RPC
RPC_URL=https://lb.drpc.live/bsc/Ahc3I-33qkfGuwXSahR3xfMHZiZ_sBMR8Lq_QrxF2MGT
RPC_WS_URL=wss://lb.drpc.live/bsc/Ahc3I-33qkfGuwXSahR3XfMHZiZ_sBMR8Lq_QrxF2MGT

# Redis é€£æ¥
REDIS_URL=redis://default:dDNaLWNZNYxRUQnBqBqqxTKSZCipKrIq@shortline.proxy.rlwy.net:59603

# PostgreSQL é€£æ¥
POSTGRES_URL=postgresql://postgres:BNZBLlmabnlgGrrQZogYUVQhDqFLRvuA@turntable.proxy.rlwy.net:53166/railway
```

### åˆç´„é…ç½®

- **åˆç´„åœ°å€**ï¼š`0x18B2A687610328590Bc8F2e5fEdDe3b582A49cdA`
- **ABI æ–‡ä»¶**ï¼š`./abi.json`
- **æ”¯æŒäº‹ä»¶**ï¼šStartRound, LockRound, EndRound, BetBull, BetBear, Claim

## ğŸ“Š æ•¸æ“šåº«çµæ§‹

### ä¸»è¦è¡¨æ ¼

| è¡¨æ ¼å | ç”¨é€” | é—œéµç‰¹æ€§ |
|--------|------|----------|
| `round` | å±€æ¬¡ä¿¡æ¯ | ä¸»éµ epochï¼ŒåŒ…å«åƒ¹æ ¼ã€æ™‚é–“ã€é‡‘é¡ç­‰ |
| `hisBet` | æ­·å²ä¸‹æ³¨è¨˜éŒ„ | æŒ‰å±€æ¬¡å’ŒéŒ¢åŒ…åœ°å€ç´¢å¼• |
| `claim` | çé‡‘é ˜å–è¨˜éŒ„ | å”¯ä¸€ç´¢å¼• (epoch, walletAddress, betEpoch) |
| `multiClaim` | å·¨é¯¨è¡Œç‚ºæª¢æ¸¬ | è¨˜éŒ„å¤§é‡é ˜å–çš„ç”¨æˆ¶è¡Œç‚º |
| `realBet` | å¯¦æ™‚ä¸‹æ³¨æ•¸æ“š | è‡¨æ™‚è¡¨ï¼Œç”±å…¶ä»–ç³»çµ±å¯«å…¥ |
| `finEpoch` | å®Œæˆæ¨™è¨˜ | å·²è™•ç†å±€æ¬¡è¨˜éŒ„ |
| `errEpoch` | éŒ¯èª¤æ—¥èªŒ | è™•ç†å¤±æ•—çš„å±€æ¬¡è¨˜éŒ„ |

### ç´¢å¼•ç­–ç•¥

```sql
-- ä¸»è¦ç´¢å¼•
CREATE INDEX idx_hisbet_epoch ON hisBet(epoch);
CREATE INDEX idx_hisbet_wallet ON hisBet(walletAddress);
CREATE UNIQUE INDEX idx_claim_unique ON claim(epoch, walletAddress, betEpoch);

-- æ€§èƒ½å„ªåŒ–ç´¢å¼•
CREATE INDEX idx_realbet_block ON realBet(blockNumber);
CREATE INDEX idx_finepoch_completed ON finEpoch(completedAt DESC);
```

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### åŸºæœ¬æ“ä½œ

**å•Ÿå‹•ç³»çµ±**
```bash
npm start
```

**é–‹ç™¼æ¨¡å¼ï¼ˆè‡ªå‹•é‡å•Ÿï¼‰**
```bash
npm run dev
```

**å‰µå»ºæ•¸æ“šåº«çµæ§‹**
```bash
npm run create-schema
```

**æ¸¬è©¦é€£æ¥**
```bash
npm test
```

### é«˜ç´šæ“ä½œ

**é‡ç½®æ•¸æ“šåº«**
```bash
node scripts/createSchema.js reset
```

**æŸ¥çœ‹æ•¸æ“šåº«çµ±è¨ˆ**
```bash
node scripts/createSchema.js stats
```

**æ¸…ç†èˆŠæ—¥èªŒ**
```bash
# æ—¥èªŒæ–‡ä»¶è‡ªå‹•è¼ªè½‰ï¼Œä¹Ÿå¯æ‰‹å‹•æ¸…ç†
rm -f logs/hisbet-*.log
```

## ğŸ“ˆ ç›£æ§èˆ‡ç¶­è­·

### æ—¥èªŒç›£æ§

ç³»çµ±æä¾›å®Œæ•´çš„æ—¥èªŒè¨˜éŒ„åŠŸèƒ½ï¼š

- **æ§åˆ¶å°è¼¸å‡º**ï¼šå¯¦æ™‚é¡¯ç¤ºè™•ç†ç‹€æ…‹
- **æ–‡ä»¶æ—¥èªŒ**ï¼šæŒ‰æ—¥æœŸè¼ªè½‰ï¼Œä¿å­˜æ–¼ `logs/` ç›®éŒ„
- **æ—¥èªŒç´šåˆ¥**ï¼šerror, warn, info, debug

```bash
# å¯¦æ™‚æŸ¥çœ‹æ—¥èªŒ
tail -f logs/hisbet-$(date +%Y-%m-%d).log

# æœç´¢éŒ¯èª¤
grep "ERROR" logs/hisbet-*.log
```

### æ€§èƒ½ç›£æ§

ç³»çµ±æä¾›æ€§èƒ½çµ±è¨ˆæ¥å£ï¼š

```javascript
// ç²å–ç³»çµ±ç‹€æ…‹
const status = scraper.scheduler.getStatus();
console.log('å·²è™•ç†å±€æ¬¡:', status.processedEpochs);
console.log('å¤±æ•—å±€æ¬¡:', status.failedEpochs);

// ç²å–æ€§èƒ½çµ±è¨ˆ
const performance = scraper.scheduler.getPerformanceStats();
console.log('æˆåŠŸç‡:', performance.successRate + '%');
```

### éŒ¯èª¤è™•ç†

ç³»çµ±å…·å‚™å®Œæ•´çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼š

1. **è‡ªå‹•é‡è©¦**ï¼šç¶²çµ¡éŒ¯èª¤è‡ªå‹•é‡è©¦
2. **å„ªé›…é™ç´š**ï¼šéƒ¨åˆ†åŠŸèƒ½å¤±æ•—ä¸å½±éŸ¿æ•´é«”é‹è¡Œ
3. **éŒ¯èª¤è¨˜éŒ„**ï¼šæ‰€æœ‰éŒ¯èª¤è¨˜éŒ„åˆ° `errEpoch` è¡¨
4. **è‡ªå‹•æ¢å¾©**ï¼šé‡å•Ÿå¾Œå¾ä¸Šæ¬¡ä½ç½®ç¹¼çºŒè™•ç†

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

**1. é€£æ¥å¤±æ•—**
```bash
# æª¢æŸ¥ç¶²çµ¡é€£æ¥
curl -X POST RPC_URL -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
```

**2. æ•¸æ“šä¸ä¸€è‡´**
```sql
-- æª¢æŸ¥ finEpoch è¨˜éŒ„
SELECT epoch, completedAt FROM finEpoch ORDER BY epoch DESC LIMIT 10;

-- æª¢æŸ¥éŒ¯èª¤è¨˜éŒ„
SELECT epoch, errorTime, errorMessage FROM errEpoch ORDER BY errorTime DESC LIMIT 10;
```

**3. æ€§èƒ½å•é¡Œ**
```bash
# æª¢æŸ¥ Redis é–ç‹€æ…‹
redis-cli keys "lock:pancake:epoch:*" | wc -l

# æª¢æŸ¥è³‡æ–™åº«é€£æ¥æ•¸
SELECT count(*) FROM pg_stat_activity WHERE state = 'active';
```

### èª¿è©¦æ¨¡å¼

å•Ÿç”¨è©³ç´°æ—¥èªŒï¼š

```bash
LOG_LEVEL=debug npm start
```

## ğŸ“š API åƒè€ƒ

### ä¸»è¦é¡åˆ¥

#### HisBetScraper
ä¸»è¦çš„ç³»çµ±æ§åˆ¶å™¨é¡åˆ¥ã€‚

**æ–¹æ³•**ï¼š
- `start()` - å•Ÿå‹•ç³»çµ±
- `gracefulShutdown()` - å„ªé›…é—œé–‰
- `processEpoch(epoch)` - è™•ç†æŒ‡å®šå±€æ¬¡

#### Database
è³‡æ–™åº«ç®¡ç†å™¨ã€‚

**æ–¹æ³•**ï¼š
- `connect()` - é€£æ¥è³‡æ–™åº«
- `transaction(callback)` - åŸ·è¡Œäº‹å‹™
- `checkFinEpoch(epoch)` - æª¢æŸ¥å±€æ¬¡æ˜¯å¦å®Œæˆ

#### EventScraper
å€å¡Šéˆäº‹ä»¶æŠ“å–å™¨ã€‚

**æ–¹æ³•**ï¼š
- `getCurrentEpoch()` - ç²å–ç•¶å‰å±€æ¬¡
- `getBlockRangeForEpoch(epoch)` - ç²å–å€å¡Šç¯„åœ
- `fetchEventsInRange(fromBlock, toBlock)` - æŠ“å–äº‹ä»¶

## ğŸ¤ è²¢ç»æŒ‡å—

### é–‹ç™¼è¨­ç½®

1. Fork é …ç›®
2. å‰µå»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/amazing-feature`
3. æäº¤æ›´æ”¹ï¼š`git commit -m 'Add amazing feature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/amazing-feature`
5. æäº¤ Pull Request

### ä»£ç¢¼è¦ç¯„

- éµå¾ª ESLint é…ç½®
- ä½¿ç”¨ camelCase å‘½å
- æ·»åŠ é©ç•¶çš„è¨»é‡‹
- ç¢ºä¿æ‰€æœ‰æ¸¬è©¦é€šé

## ğŸ“„ è¨±å¯è­‰

æœ¬é …ç›®ä½¿ç”¨ MIT è¨±å¯è­‰ã€‚è©³è¦‹ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ†˜ æ”¯æ´

å¦‚é‡åˆ°å•é¡Œæˆ–éœ€è¦å¹«åŠ©ï¼š

1. æŸ¥çœ‹ [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤) ç¯€ç›®
2. æœç´¢ [Issues](../../issues)
3. å‰µå»ºæ–°çš„ Issue

## ğŸ“ æ›´æ–°æ—¥èªŒ

### v2.2 (ç•¶å‰ç‰ˆæœ¬)
- âœ… å¯¦ç¾é›™è»Œä½µç™¼æ§åˆ¶æ©Ÿåˆ¶
- âœ… æ·»åŠ  Redis é–é˜² race condition
- âœ… å®Œå–„æ•¸æ“šé©—è­‰é‚è¼¯
- âœ… å¯¦ç¾äº‹å‹™æ€§å¯«å…¥
- âœ… æ·»åŠ å®Œæ•´çš„æ—¥èªŒç³»çµ±
- âœ… æ”¯æ´éŒ¯èª¤æ—¥èªŒè¨˜éŒ„

### è¨ˆåŠƒåŠŸèƒ½
- [ ] Web ç•Œé¢ç®¡ç†
- [ ] æ›´å¤šé©—è­‰è¦å‰‡
- [ ] æ€§èƒ½å„ªåŒ–
- [ ] ç›£æ§å‘Šè­¦

---

**ğŸ¯ é …ç›®ç›®æ¨™**ï¼šæ§‹å»ºç©©å®šã€é«˜æ•ˆçš„å€å¡Šéˆæ­·å²æ•¸æ“šæŠ“å–ç³»çµ±ï¼Œç‚ºæ•¸æ“šåˆ†æå’Œç ”ç©¶æä¾›å¯é æ”¯æŒã€‚